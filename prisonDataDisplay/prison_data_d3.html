<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .axis path,
  .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
  }

  .axis text {
      font-family: sans-serif;
      font-size: 11px;
  }

</style>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="prisonData.js"></script>
<body>
<script>

  var h = 800;
  var w = 1000;
  var barPadding = 2;
  var padding = 30;

  var svg = d3.select("body").append("svg")
              .attr("height", h)
              .attr("width", w);

  var parseDate = d3.time.format("%m/%d/%y").parse



  // prison_data.forEach(function(d) {
  //   d.date = parseDate(d.date);
  // });

  var dataByGroup = 
    d3.nest()
      // .key(function (d) { return d.date.getFullYear(); })
      .key(function (d) { return parseDate(d.date).getFullYear(); })
      .rollup(function (v) { return {
        count: v.length,
        avg_age: d3.mean(v, function(d) { return d.age; })
      }; })
      .entries(prison_data);
  console.log(dataByGroup);
  console.log(dataByGroup.length);

  var xScale = d3.scale.linear()
                 .domain([d3.min(dataByGroup, function (d) { return d.key}),
                         d3.max(dataByGroup, function (d) { return d.key})])
                 .range([padding, w-padding]);
  console.log(xScale(970));

  var yScaleCount = d3.scale.linear()
                      .domain([d3.min(dataByGroup, function (d) { return d.values.count}),
                              d3.max(dataByGroup, function (d) { return d.values.count})])
                      .range([0,h]);

  var yScaleAge = d3.scale.linear()
                    .domain([d3.min(dataByGroup, function (d) { return d.values.avg_age}),
                            d3.max(dataByGroup, function (d) { return d.values.avg_age})])
                    .range([0, h/2]);

  var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");

  var yAxisLeft = d3.svg.axis()
                .scale(yScaleAge)
                .orient("left")

  var yAxisRight = d3.svg.axis()
                .scale(yScaleCount)
                .orient("right")

  var bars = svg.selectAll("rect")
              .data(dataByGroup)
              .enter()
              .append("rect");

  var points = svg.selectAll("circle")
                .data(dataByGroup)
                .enter()
                .append("circle")

  bars.attr("height", function(d) {return d.values.count * 5 } )
      // .attr("width", 20)
      .attr("width", ((w-(2*padding)) / dataByGroup.length - barPadding))
      .attr("y", function (d){ return ((h-padding)/2) - (d.values.count * 5)})
      .attr("x", function (d,i){
        // return (i * 30)
        return (i * ((w-(2*padding)) / dataByGroup.length)) + padding })
      .attr("fill", "red")
      // .attr("fill", function (d) {
      //   return "rgb(0, 0, " + (d.values.count * 10) + ")"; });

  points.attr("cx", function (d,i) { 
        return (i * (w / dataByGroup.length)) + ((w / dataByGroup.length - barPadding) / 2) })
      .attr("cy", function (d) { return yScaleAge(d.values.avg_age) })
      // .attr("cy", function (d){ return (h/2) - (d.values.count * 5)})
      .attr("r", 5)
      // .attr("fill", "white")

  svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + (h - padding) /2 + ")")
      .call(xAxis);

  svg.append("g")
     .attr("class", "axis")
     .attr ("transform", "translate(" + padding + ",0)")
     .call(yAxisLeft)

</script>
</body>
